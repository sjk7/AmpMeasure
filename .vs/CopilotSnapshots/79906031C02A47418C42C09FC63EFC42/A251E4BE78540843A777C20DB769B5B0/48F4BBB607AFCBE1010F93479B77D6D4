using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Runtime.InteropServices;
using System.IO;
using System.Xml.Serialization;

namespace AmpMeasure
{
    public partial class AmpMeasureMain : Form
{
        private bool _isLoadingColumns = false;
        private bool _isLoadingWindow = false;
        private bool _isCalculating = false;
        private bool _isDirty = false;
        private string _currentFilePath = null;

    [DllImport("user32.dll", CharSet = CharSet.Auto)] extern static bool DestroyIcon(IntPtr handle);

  public
    AmpMeasureMain()
    {
        InitializeComponent();
        SetAppIcon();
        SetDefaultFormSize();
        InitializeGrid();
        SetupColumnIcons();
        SetupMenuIcons();
        LoadColumnOrder();
        LoadColumnWidths();
        LoadWindowSettings();
        UpdateMRUMenu();
    }

  private
    void SetAppIcon()
    {
        try
        {
            using(Bitmap bmp = ColumnIconHelper.CreateAppIconImage())
            {
                IntPtr hIcon = bmp.GetHicon();
                using(Icon icon = Icon.FromHandle(hIcon))
                {
                    this.Icon = (Icon)icon.Clone();
                }
                DestroyIcon(hIcon);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to set app icon: {ex.Message}");
        }
    }

  private
    void SetupMenuIcons()
    {
        openToolStripMenuItem.Image = ColumnIconHelper.CreateOpenIcon();
        saveToolStripMenuItem.Image = ColumnIconHelper.CreateSaveIcon();
        saveAsToolStripMenuItem.Image = ColumnIconHelper.CreateSaveAsIcon();

        viewToolStripMenuItem.Image = ColumnIconHelper.CreateViewIcon();
        resetColumnWidthsToolStripMenuItem.Image = ColumnIconHelper.CreateResetWidthsIcon();
        resetColumnOrderToolStripMenuItem.Image = ColumnIconHelper.CreateResetOrderIcon();
        clearGridToolStripMenuItem.Image = ColumnIconHelper.CreateClearGridIcon();
    }

  private
    void SetDefaultFormSize()
    {
        int totalWidth = 0;
        foreach (DataGridViewColumn column in dataGridView1.Columns)
        {
            totalWidth += 100;
        }

        totalWidth += SystemInformation.VerticalScrollBarWidth + 20;

        this.ClientSize = new Size(totalWidth, 450);
    }

  private
    void InitializeGrid()
    {
        dataGridView1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
        dataGridView1.RowTemplate.Height = 25;
        
            // Set calculated columns to read-only
            colRMSVolts.ReadOnly = true;
            colPowerIn.ReadOnly = true;
            colPowerOut.ReadOnly = true;
            colEfficiency.ReadOnly = true;

            dataGridView1.ColumnWidthChanged += DataGridView1_ColumnWidthChanged;
            dataGridView1.ColumnDisplayIndexChanged += DataGridView1_ColumnDisplayIndexChanged;
            dataGridView1.DefaultValuesNeeded += DataGridView1_DefaultValuesNeeded;
            dataGridView1.CellValueChanged += DataGridView1_CellValueChanged;
            dataGridView1.RowsAdded += DataGridView1_RowsAdded;
            dataGridView1.RowsRemoved += DataGridView1_RowsRemoved;
            
            AddInitialRows(5);
    }

  private
    void SetupColumnIcons()
    {
        SetColumnHeaderWithIcon(colPeakVolts, "Peak Volts", ColumnIconHelper.CreatePeakVoltsIcon());
        SetColumnHeaderWithIcon(colRMSVolts, "RMS Volts", ColumnIconHelper.CreateRMSVoltsIcon());
        SetColumnHeaderWithIcon(colSupplyCurrent, "Supply Current", ColumnIconHelper.CreateCurrentIcon());
        SetColumnHeaderWithIcon(colSupplyVoltage, "Supply Voltage", ColumnIconHelper.CreateVoltageIcon());
        SetColumnHeaderWithIcon(colPowerIn, "Power In", ColumnIconHelper.CreatePowerInIcon());
        SetColumnHeaderWithIcon(colPowerOut, "Power Out", ColumnIconHelper.CreatePowerOutIcon());
        SetColumnHeaderWithIcon(colEfficiency, "Efficiency", ColumnIconHelper.CreateEfficiencyIcon());
        SetColumnHeaderWithIcon(colLoadResistance, "Load Resistance", ColumnIconHelper.CreateResistanceIcon());
        SetColumnHeaderWithIcon(colDateTime, "Date/Time", ColumnIconHelper.CreateDateTimeIcon());
    }

  private
    void SetColumnHeaderWithIcon(DataGridViewColumn column, string text, Bitmap icon)
    {
        column.HeaderText = " " + text;
        
        if (dataGridView1.ColumnHeadersDefaultCellStyle.Padding == Padding.Empty)
        {
            dataGridView1.ColumnHeadersDefaultCellStyle.Padding = new Padding(20, 0, 0, 0);
        }
        
        dataGridView1.Paint += (sender, e) =>
        {
            foreach (DataGridViewColumn col in dataGridView1.Columns)
            {
                Rectangle rect = dataGridView1.GetCellDisplayRectangle(col.Index, -1, true);
                if (rect.Width > 0)
                {
                    Bitmap colIcon = null;
                    if (col == colPeakVolts) colIcon = ColumnIconHelper.CreatePeakVoltsIcon();
                    else if (col == colRMSVolts) colIcon = ColumnIconHelper.CreateRMSVoltsIcon();
                    else if (col == colSupplyCurrent) colIcon = ColumnIconHelper.CreateCurrentIcon();
                    else if (col == colSupplyVoltage) colIcon = ColumnIconHelper.CreateVoltageIcon();
                    else if (col == colPowerIn) colIcon = ColumnIconHelper.CreatePowerInIcon();
                    else if (col == colPowerOut) colIcon = ColumnIconHelper.CreatePowerOutIcon();
                    else if (col == colEfficiency) colIcon = ColumnIconHelper.CreateEfficiencyIcon();
                    else if (col == colLoadResistance) colIcon = ColumnIconHelper.CreateResistanceIcon();
                    else if (col == colDateTime) colIcon = ColumnIconHelper.CreateDateTimeIcon();

                    if (colIcon != null)
                    {
                        e.Graphics.DrawImage(colIcon, rect.Left + 2, rect.Top + (rect.Height - 16) / 2, 16, 16);
                        colIcon.Dispose();
                    }
                }
            }
        };
    }

  private
    void AddInitialRows(int count)
    {
        for (int i = 0; i < count; i++)
        {
            int rowIndex = dataGridView1.Rows.Add();
            dataGridView1.Rows[rowIndex].Cells["colSupplyVoltage"].Value = 50;
            dataGridView1.Rows[rowIndex].Cells["colLoadResistance"].Value = 50;
            dataGridView1.Rows[rowIndex].Cells["colDateTime"].Value = DateTime.Now.ToString("g");
        }
    }

  private
    void DataGridView1_DefaultValuesNeeded(object sender, DataGridViewRowEventArgs e)
    {
        e.Row.Cells["colSupplyVoltage"].Value = 50;
        e.Row.Cells["colLoadResistance"].Value = 50;
        e.Row.Cells["colDateTime"].Value = DateTime.Now.ToString("g");
    }

  private
    void DataGridView1_CellValueChanged(object sender, DataGridViewCellEventArgs e)
    {
        if (e.RowIndex < 0) return;
        
        if (!_isLoadingColumns && !_isCalculating)
        {
            _isDirty = true;
        }
        
        // Avoid recursion if we are updating calculated cells
        if (_isCalculating) return;

        string colName = dataGridView1.Columns[e.ColumnIndex].Name;
        
        if (colName == "colPeakVolts" || 
            colName == "colSupplyCurrent" || 
            colName == "colSupplyVoltage" || 
            colName == "colLoadResistance")
        {
            CalculateRow(e.RowIndex);
        }
    }

    private void CalculateRow(int rowIndex)
    {
      _isCalculating = true;
      try
      {
          var row = dataGridView1.Rows[rowIndex];
          
          // Get inputs
          if (!double.TryParse(Convert.ToString(row.Cells["colPeakVolts"].Value), out double peakVolts)) peakVolts = 0;
          if (!double.TryParse(Convert.ToString(row.Cells["colSupplyCurrent"].Value), out double supplyCurrent)) supplyCurrent = 0;
          if (!double.TryParse(Convert.ToString(row.Cells["colSupplyVoltage"].Value), out double supplyVoltage)) supplyVoltage = 0;
          if (!double.TryParse(Convert.ToString(row.Cells["colLoadResistance"].Value), out double loadResistance)) loadResistance = 0;

          // Calculate RMS Volts (Peak * 0.707)
          double rmsVolts = peakVolts * 0.70710678;
          row.Cells["colRMSVolts"].Value = Math.Round(rmsVolts, 3);

          // Calculate Power In (Supply V * Supply I)
          double powerIn = supplyVoltage * supplyCurrent;
          row.Cells["colPowerIn"].Value = Math.Round(powerIn, 3);

          // Calculate Power Out (RMS^2 / Load R)
          double powerOut = 0;
          if (loadResistance != 0)
          {
              powerOut = (rmsVolts * rmsVolts) / loadResistance;
          }
          row.Cells["colPowerOut"].Value = Math.Round(powerOut, 3);

          // Calculate Efficiency (Power Out / Power In * 100)
          double efficiency = 0;
          if (powerIn != 0)
          {
              efficiency = (powerOut / powerIn) * 100;
          }
          row.Cells["colEfficiency"].Value = Math.Round(efficiency, 2);
      }
      finally
      {
          _isCalculating = false;
      }
  }

  private
    void LoadColumnOrder()
    {
        if (string.IsNullOrWhiteSpace(Properties.Settings.Default.ColumnOrder))
        {
            return;
        }

        try
        {
            _isLoadingColumns = true;

            var orderPairs = Properties.Settings.Default.ColumnOrder.Split(',');

            if (orderPairs.Length != dataGridView1.Columns.Count)
            {
                ResetColumnOrderSettings();
                return;
            }

            var orderMap = new Dictionary<string, int>();
            foreach (var pair in orderPairs)
            {
                var parts = pair.Split(':');
                if (parts.Length == 2 && int.TryParse(parts[1], out int displayIndex))
                {
                    orderMap[parts[0]] = displayIndex;
                }
                else
                {
                    ResetColumnOrderSettings();
                    return;
                }
            }

            foreach (DataGridViewColumn column in dataGridView1.Columns)
            {
                if (orderMap.ContainsKey(column.Name))
                {
                    int newIndex = orderMap[column.Name];
                    if (newIndex >= 0 && newIndex < dataGridView1.Columns.Count)
                    {
                        column.DisplayIndex = newIndex;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to load column order: {ex.Message}");
            ResetColumnOrderSettings();
        }
        finally
        {
            _isLoadingColumns = false;
        }
    }

  private
    void SaveColumnOrder()
    {
        if (_isLoadingColumns)
        {
            return;
        }

        try
        {
            var orderPairs = new List<string>();
            foreach (DataGridViewColumn column in dataGridView1.Columns)
            {
                orderPairs.Add($"{column.Name}:{column.DisplayIndex}");
            }
            Properties.Settings.Default.ColumnOrder = string.Join(",", orderPairs);
            Properties.Settings.Default.Save();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to save column order: {ex.Message}");
        }
    }

  private
    void ResetColumnOrderSettings()
    {
        try
        {
            Properties.Settings.Default.ColumnOrder = string.Empty;
            Properties.Settings.Default.Save();
            
            // User inputs first: Peak Volts, Current, Power Out (as requested)
            colPeakVolts.DisplayIndex = 0;
            colSupplyCurrent.DisplayIndex = 1;
            colPowerOut.DisplayIndex = 2;
            
            // Rest of the columns
            colRMSVolts.DisplayIndex = 3;
            colSupplyVoltage.DisplayIndex = 4;
            colPowerIn.DisplayIndex = 5;
            colEfficiency.DisplayIndex = 6;
            colLoadResistance.DisplayIndex = 7;
            colDateTime.DisplayIndex = 8;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to reset column order: {ex.Message}");
        }
    }

  private
    void LoadColumnWidths()
    {
        if (string.IsNullOrWhiteSpace(Properties.Settings.Default.ColumnWidths))
        {
            return;
        }

        try
        {
            _isLoadingColumns = true;

            var widths = Properties.Settings.Default.ColumnWidths.Split(',');

            if (widths.Length != dataGridView1.Columns.Count)
            {
                ResetColumnWidthSettings();
                return;
            }

            var parsedWidths = new List<int>();
            foreach (var widthStr in widths)
            {
                if (!int.TryParse(widthStr, out int width) || width < 10 || width > 5000)
                {
                    ResetColumnWidthSettings();
                    return;
                }
                parsedWidths.Add(width);
            }

            dataGridView1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.None;
            for (int i = 0; i < parsedWidths.Count; i++)
            {
                dataGridView1.Columns[i].Width = parsedWidths[i];
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to load column widths: {ex.Message}");
            ResetColumnWidthSettings();
        }
        finally
        {
            _isLoadingColumns = false;
        }
    }

  private
    void SaveColumnWidths()
    {
        if (_isLoadingColumns)
        {
            return;
        }

        try
        {
            var widths = new List<string>();
            foreach (DataGridViewColumn column in dataGridView1.Columns)
            {
                widths.Add(column.Width.ToString());
            }
            Properties.Settings.Default.ColumnWidths = string.Join(",", widths);
            Properties.Settings.Default.Save();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to save column widths: {ex.Message}");
        }
    }

  private
    void ResetColumnWidthSettings()
    {
        try
        {
            Properties.Settings.Default.ColumnWidths = string.Empty;
            Properties.Settings.Default.Save();
            dataGridView1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to reset column widths: {ex.Message}");
        }
    }

  private
    void LoadWindowSettings()
    {
        try
        {
            _isLoadingWindow = true;

            var savedSize = Properties.Settings.Default.WindowSize;
            var savedLocation = Properties.Settings.Default.WindowLocation;
            var savedState = Properties.Settings.Default.WindowState;

            if (savedSize.Width > 0 && savedSize.Height > 0)
            {
                this.Size = savedSize;
            }

            if (savedLocation.X != 0 || savedLocation.Y != 0)
            {
                if (IsLocationVisible(savedLocation, this.Size))
                {
                    this.StartPosition = FormStartPosition.Manual;
                    this.Location = savedLocation;
                }
            }

            if (savedState != FormWindowState.Minimized)
            {
                this.WindowState = savedState;
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to load window settings: {ex.Message}");
        }
        finally
        {
            _isLoadingWindow = false;
        }
    }

  private
    bool IsLocationVisible(Point location, Size size)
    {
        Rectangle formRectangle = new Rectangle(location, size);

        foreach (Screen screen in Screen.AllScreens)
        {
            if (screen.WorkingArea.IntersectsWith(formRectangle))
            {
                return true;
            }
        }

        return false;
    }

  private
    void SaveWindowSettings()
    {
        if (_isLoadingWindow)
        {
            return;
        }

        try
        {
            if (this.WindowState == FormWindowState.Normal)
            {
                Properties.Settings.Default.WindowSize = this.Size;
                Properties.Settings.Default.WindowLocation = this.Location;
            }

            Properties.Settings.Default.WindowState = this.WindowState;
            Properties.Settings.Default.Save();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to save window settings: {ex.Message}");
        }
    }

  private
    void DataGridView1_ColumnWidthChanged(object sender, DataGridViewColumnEventArgs e)
    {
        if (dataGridView1.AutoSizeColumnsMode == DataGridViewAutoSizeColumnsMode.None && !_isLoadingColumns)
        {
            SaveColumnWidths();
        }
    }

  private
    void DataGridView1_ColumnDisplayIndexChanged(object sender, DataGridViewColumnEventArgs e)
    {
        if (!_isLoadingColumns)
        {
            SaveColumnOrder();
        }
    }

  private
    void resetColumnWidthsToolStripMenuItem_Click(object sender, EventArgs e)
    {
        ResetColumnWidthSettings();
        MessageBox.Show("Column widths have been reset to default.", "Reset Complete", MessageBoxButtons.OK,
                        MessageBoxIcon.Information);
    }

  private
    void resetColumnOrderToolStripMenuItem_Click(object sender, EventArgs e)
    {
        ResetColumnOrderSettings();
        MessageBox.Show("Column order has been reset to default.", "Reset Complete", MessageBoxButtons.OK,
                        MessageBoxIcon.Information);
    }

  private
    void clearGridToolStripMenuItem_Click(object sender, EventArgs e)
    {
        if (MessageBox.Show("Are you sure you want to clear all rows from the grid?", "Confirm Clear",
                            MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
        {
            dataGridView1.Rows.Clear();
        }
    }

  private
    void openToolStripMenuItem_Click(object sender, EventArgs e)
    {
        if (openFileDialog1.ShowDialog() == DialogResult.OK)
        {
            LoadWorksheet(openFileDialog1.FileName);
        }
    }

  private
    void saveToolStripMenuItem_Click(object sender, EventArgs e)
    {
        if (string.IsNullOrEmpty(_currentFilePath))
        {
            saveAsToolStripMenuItem_Click(sender, e);
        }
        else
        {
            SaveWorksheet(_currentFilePath);
        }
    }

  private
    void saveAsToolStripMenuItem_Click(object sender, EventArgs e)
    {
        if (saveFileDialog1.ShowDialog() == DialogResult.OK)
        {
            SaveWorksheet(saveFileDialog1.FileName);
        }
    }

  private
    void UpdateMRUMenu()
    {
        recentFilesToolStripMenuItem.DropDownItems.Clear();
        
        if (string.IsNullOrEmpty(Properties.Settings.Default.MRUList))
        {
            recentFilesToolStripMenuItem.Enabled = false;
            return;
        }

        var files = Properties.Settings.Default.MRUList.Split(new[] { '|' }, StringSplitOptions.RemoveEmptyEntries);
        if (files.Length == 0)
        {
            recentFilesToolStripMenuItem.Enabled = false;
            return;
        }

        recentFilesToolStripMenuItem.Enabled = true;
        for (int i = 0; i < files.Length; i++)
        {
            string file = files[i];
            var item = new ToolStripMenuItem($"{i + 1}. {Path.GetFileName(file)}");
            item.Tag = file;
            item.Click += (s, e) => LoadWorksheet((string)((ToolStripMenuItem)s).Tag);
            recentFilesToolStripMenuItem.DropDownItems.Add(item);
        }
    }

  private
    void AddToMRU(string filePath)
    {
        try
        {
            var files = new List<string>();
            if (!string.IsNullOrEmpty(Properties.Settings.Default.MRUList))
            {
                files.AddRange(Properties.Settings.Default.MRUList.Split(new[] { '|' }, StringSplitOptions.RemoveEmptyEntries));
            }

            // Remove if exists (to move to top)
            files.RemoveAll(f => f.Equals(filePath, StringComparison.OrdinalIgnoreCase));
            
            // Add to top
            files.Insert(0, filePath);
            
            // Keep max 10
            if (files.Count > 10)
            {
                files = files.Take(10).ToList();
            }

            Properties.Settings.Default.MRUList = string.Join("|", files);
            Properties.Settings.Default.Save();
            
            UpdateMRUMenu();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to update MRU list: {ex.Message}");
        }
    }

  private
    void SaveWorksheet(string filename)
    {
        try
        {
            var data = new WorksheetData();

            // Save columns
            foreach (DataGridViewColumn col in dataGridView1.Columns)
            {
                data.Columns.Add(new WorksheetColumn{Name = col.Name, HeaderText = col.HeaderText, Width = col.Width,
                                                     DisplayIndex = col.DisplayIndex});
            }

            // Save rows
            foreach (DataGridViewRow row in dataGridView1.Rows)
            {
                if (row.IsNewRow)
                    continue;

                var rowData = new List<string>();
                foreach (DataGridViewColumn col in dataGridView1.Columns)
                {
                    var cellValue = row.Cells[col.Name].Value;
                    rowData.Add(cellValue != null ? cellValue.ToString() : "");
                }
                data.Rows.Add(rowData);
            }

            XmlSerializer serializer = new XmlSerializer(typeof(WorksheetData));
            using(TextWriter writer = new StreamWriter(filename))
            {
                serializer.Serialize(writer, data);
            }

            _currentFilePath = filename;
            this.Text = $"Amp Measure - {Path.GetFileName(filename)}";
            AddToMRU(filename);
            MessageBox.Show("Worksheet saved successfully.", "Save Complete", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to save worksheet: {ex.Message}", "Save Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }

  private
    void LoadWorksheet(string filename)
    {
        try
        {
            if (!File.Exists(filename))
            {
                // Remove from MRU if not found
                var files = new List<string>();
                if (!string.IsNullOrEmpty(Properties.Settings.Default.MRUList))
                {
                    files.AddRange(Properties.Settings.Default.MRUList.Split(new[] { '|' }, StringSplitOptions.RemoveEmptyEntries));
                    if (files.RemoveAll(f => f.Equals(filename, StringComparison.OrdinalIgnoreCase)) > 0)
                    {
                        Properties.Settings.Default.MRUList = string.Join("|", files);
                        Properties.Settings.Default.Save();
                        UpdateMRUMenu();
                    }
                }
                MessageBox.Show($"File not found: {filename}", "Load Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            XmlSerializer serializer = new XmlSerializer(typeof(WorksheetData));
            WorksheetData data;

            using(TextReader reader = new StreamReader(filename))
            {
                data = (WorksheetData)serializer.Deserialize(reader);
            }

            // Apply data
            _isLoadingColumns = true;
            dataGridView1.Rows.Clear();

            // Restore columns
            foreach (var colData in data.Columns)
            {
                if (dataGridView1.Columns.Contains(colData.Name))
                {
                    var col = dataGridView1.Columns[colData.Name];
                    col.Width = colData.Width;
                    // Ensure DisplayIndex is valid
                    if (colData.DisplayIndex >= 0 && colData.DisplayIndex < dataGridView1.Columns.Count)
                    {
                        col.DisplayIndex = colData.DisplayIndex;
                    }
                }
            }

            // Restore rows
            foreach (var rowData in data.Rows)
            {
                int rowIndex = dataGridView1.Rows.Add();
                for (int i = 0; i < rowData.Count && i < dataGridView1.Columns.Count; i++)
                {
                    var col = dataGridView1.Columns[i];
                    dataGridView1.Rows[rowIndex].Cells[col.Name].Value = rowData[i];
                }
            }

            _isLoadingColumns = false;
            _currentFilePath = filename;
            this.Text = $"Amp Measure - {Path.GetFileName(filename)}";
            AddToMRU(filename);
        }
        catch (Exception ex)
        {
            _isLoadingColumns = false;
            MessageBox.Show($"Failed to load worksheet: {ex.Message}", "Load Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }

protected
override void OnResizeEnd(EventArgs e)
{
    base.OnResizeEnd(e);
    SaveWindowSettings();
}

protected
override void OnLocationChanged(EventArgs e)
{
    base.OnLocationChanged(e);
    if (!_isLoadingWindow && this.WindowState == FormWindowState.Normal)
    {
        SaveWindowSettings();
    }
}

protected
override void OnFormClosing(FormClosingEventArgs e)
{
    base.OnFormClosing(e);
    if (dataGridView1.AutoSizeColumnsMode == DataGridViewAutoSizeColumnsMode.None && !_isLoadingColumns)
    {
        SaveColumnWidths();
    }
    SaveColumnOrder();
    SaveWindowSettings();
}
}

[Serializable] public class WorksheetData
{
  public
    List<WorksheetColumn> Columns
    {
        get;
        set;
    }
  public
    List<List<string>> Rows
    {
        get;
        set;
    }

  public
    WorksheetData()
    {
        Columns = new List<WorksheetColumn>();
        Rows = new List<List<string>>();
    }
}

    [Serializable] public class WorksheetColumn
{
  public
    string Name
    {
        get;
        set;
    }
  public
    string HeaderText
    {
        get;
        set;
    }
  public
    int Width
    {
        get;
        set;
    }
  public
    int DisplayIndex
    {
        get;
        set;
    }
}
}
