using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace AmpMeasure
{
    public partial class AmpMeasureMain
    {
        private async void generateTestDataToolStripMenuItem_Click(object sender, EventArgs e)
        {
            var result = MessageBox.Show(
                "This will generate 10,000 test rows with random data.\n\n" +
                "The grid will be cleared and new data will be generated.\n" +
                "This will test save and load performance.\n\n" +
                "Continue?",
                "Generate Test Data",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Question);

            if (result == DialogResult.Yes)
            {
                await GenerateTestDataAsync();
            }
        }

        private async Task GenerateTestDataAsync()
        {
            Stopwatch timer = new Stopwatch();
            
            long generateTime = 0;
            long addRowsTime = 0;
            long saveTime = 0;
            long loadDeserializeTime = 0;
            long loadApplyDataTime = 0;
            
            string testFilePath = null;
            
            try
            {
                // Phase 1: Generate data in memory
                timer.Start();
                SetBusy(true, "Generating 10,000 test rows in memory...");
                
                _isLoadingColumns = true;
                ClearVirtualData();

                Random random = new Random();
                int totalRows = 10000;
                object[][] rowData = null;
                
                await Task.Run(() =>
                {
                    rowData = new object[totalRows][];
                    
                    for (int i = 0; i < totalRows; i++)
                    {
                        double peakVolts = Math.Round(random.NextDouble() * 100 + 10, 2);
                        double supplyCurrent = Math.Round(random.NextDouble() * 5 + 0.5, 3);
                        double supplyVoltage = Math.Round(random.NextDouble() * 20 + 40, 1);
                        double loadResistance = Math.Round(random.NextDouble() * 100 + 20, 1);
                        double powerOut = Math.Round(random.NextDouble() * 50 + 10, 2);

                        double rmsVolts = Math.Round(peakVolts * 0.70710678, 3);
                        double powerIn = Math.Round(supplyVoltage * supplyCurrent, 3);
                        double efficiency = powerIn != 0 ? Math.Round((powerOut / powerIn) * 100, 2) : 0;

                        rowData[i] = new object[]
                        {
                            peakVolts, supplyCurrent, powerOut, rmsVolts,
                            supplyVoltage, powerIn, efficiency, loadResistance,
                            DateTime.Now.AddMinutes(-random.Next(0, 10000)).ToString("g")
                        };
                    }
                });
                
                generateTime = timer.ElapsedMilliseconds;
                timer.Restart();

                // Phase 2: Add rows to grid
                SetBusy(true, "Adding 10,000 rows to grid...");
                
                for (int i = 0; i < totalRows; i++)
                {
                    _virtualDataStore.Add(rowData[i].Select(o => o?.ToString() ?? "").ToArray());
                    
                    var tags = new Dictionary<string, string>();
                    tags["colSupplyVoltage"] = "user-edited";
                    tags["colLoadResistance"] = "user-edited";
                    _virtualCellTags[i] = tags;
                }

                SetVirtualRowCount(_virtualDataStore.Count);
                
                addRowsTime = timer.ElapsedMilliseconds;
                timer.Restart();
                
                _isLoadingColumns = false;
                _isDirty = true;
                UpdateTitle();

                // Phase 3: Save to file
                SetBusy(true, "Saving 10,000 rows to XML file...");
                
                testFilePath = Path.Combine(
                    Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments),
                    $"AmpMeasure_TestData_10K_{DateTime.Now:yyyyMMdd_HHmmss}.xml");

                await SaveWorksheetAsync(testFilePath, true);
                saveTime = timer.ElapsedMilliseconds;
                timer.Restart();

                // Phase 4: Clear grid
                SetBusy(true, "Clearing grid...");
                ClearVirtualData();
                _currentFilePath = null;

                // Phase 5: Load from file (deserialize)
                SetBusy(true, "Reading and deserializing XML file...");
                timer.Restart();
                
                loadDeserializeTime = await LoadWorksheetWithTimingAsync(testFilePath);
                loadApplyDataTime = timer.ElapsedMilliseconds - loadDeserializeTime;

                SetBusy(false);

                long totalTime = generateTime + addRowsTime + saveTime + loadDeserializeTime + loadApplyDataTime;

                MessageBox.Show(
                    $"Performance Test Complete - 10,000 Rows\n\n" +
                    $"CREATION:\n" +
                    $"  • Generate in-memory data: {generateTime:N0} ms\n" +
                    $"  • Add rows to grid: {addRowsTime:N0} ms\n" +
                    $"  Subtotal: {(generateTime + addRowsTime):N0} ms\n\n" +
                    $"SAVE:\n" +
                    $"  • Save to XML file: {saveTime:N0} ms\n\n" +
                    $"LOAD:\n" +
                    $"  • Deserialize XML: {loadDeserializeTime:N0} ms\n" +
                    $"  • Apply to grid: {loadApplyDataTime:N0} ms\n" +
                    $"  Subtotal: {(loadDeserializeTime + loadApplyDataTime):N0} ms\n\n" +
                    $"TOTAL: {totalTime:N0} ms ({(totalTime / 1000.0):F2}s)\n\n" +
                    $"File: {Path.GetFileName(testFilePath)}",
                    "Performance Test Results",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Information);
            }
            catch (Exception ex)
            {
                dataGridView1.ResumeLayout();
                _isLoadingColumns = false;
                SetBusy(false);
                MessageBox.Show(
                    $"Error during performance test:\n{ex.Message}",
                    "Error",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Error);
            }
        }
    }
}
