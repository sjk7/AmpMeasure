using System;
using System.Collections.Generic;
using System.Drawing;
using System.IO;
using System.Runtime.InteropServices;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace AmpMeasure
{
    public partial class AmpMeasureMain : Form
    {
        private bool _isLoadingColumns = false;
        private bool _isLoadingWindow = false;
        private bool _isCalculating = false;
        private bool _isDirty = false;
        private string _currentFilePath = null;
        private double _defaultSupplyVoltage = 50;
        private double _defaultLoadResistance = 50;
        private bool _isPropagatingValues = false;
        private PerformanceProfiler _profiler = new PerformanceProfiler(true);

        [DllImport("user32.dll", CharSet = CharSet.Auto)] 
        extern static bool DestroyIcon(IntPtr handle);

        public AmpMeasureMain()
        {
            this.SetStyle(ControlStyles.OptimizedDoubleBuffer | 
                          ControlStyles.AllPaintingInWmPaint | 
                          ControlStyles.UserPaint, true);
            this.UpdateStyles();
            
            SuspendLayout();
            
            InitializeComponent();
            
            _defaultSupplyVoltage = Properties.Settings.Default.DefaultSupplyVoltage;
            _defaultLoadResistance = Properties.Settings.Default.DefaultLoadResistance;
            
            darkModeToolStripMenuItem.Checked = Properties.Settings.Default.DarkMode;
            if (Properties.Settings.Default.DarkMode)
            {
                ApplyTheme(true);
            }
            
            // Remove SetAppIcon, SetupMenuIcons, SetDefaultFormSize, HideDebugMenuItems, IsDebugMode, AmpMeasureMain_KeyDown, JumpToNewEntry from this file. They are now in UIHelpers, Debug, and Shortcuts partials.

            LoadColumnOrder();
            LoadColumnWidths();
            LoadWindowSettings();
            UpdateMRUMenu();
            UpdateTitle();
            
            _isDirty = false;
            
            string lastWorksheet = Properties.Settings.Default.LastWorksheetPath;
            if (!string.IsNullOrEmpty(lastWorksheet) && File.Exists(lastWorksheet))
            {
                this.Shown += async (s, e) => { await LoadWorksheetAsync(lastWorksheet); };
            }
            
            ResumeLayout(true);
            
            dataGridView1.Refresh();
            
            // Log app startup only in debug mode
            if (IsDebugMode())
            {
                _profiler.StartTimer("App Startup");
                _profiler.StopTimer("App Startup");
                _profiler.LogToFile($"Application Started - {_virtualDataStore.Count} initial rows");
            }
        }

        private void UpdateTitle()
        {
            string fileName = string.IsNullOrEmpty(_currentFilePath) ? "Untitled" : Path.GetFileName(_currentFilePath);
            this.Text = $"Amp Measure - {fileName}" + (_isDirty ? "*" : "");
        }

        private void SetBusy(bool busy, string message = "")
        {
            if (busy)
            {
                Cursor.Current = Cursors.WaitCursor;
                menuStrip1.Enabled = false;
                dataGridView1.Enabled = false;
                toolStripStatusLabel1.Text = message;
            }
            else
            {
                Cursor.Current = Cursors.Default;
                menuStrip1.Enabled = true;
                dataGridView1.Enabled = true;
                toolStripStatusLabel1.Text = "Ready";
            }
        }
    }
}
