using System;
using System.Drawing;
using System.Windows.Forms;

namespace AmpMeasure
{
    public partial class AmpMeasureMain
    {
        private void InitializeGrid()
        {
            dataGridView1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            dataGridView1.RowTemplate.Height = 25;
            
            colRMSVolts.ReadOnly = true;
            colPowerIn.ReadOnly = true;
            colEfficiency.ReadOnly = true;

            EnableVirtualMode();

            dataGridView1.ColumnWidthChanged += DataGridView1_ColumnWidthChanged;
            dataGridView1.ColumnDisplayIndexChanged += DataGridView1_ColumnDisplayIndexChanged;
            dataGridView1.CellPainting += DataGridView1_CellPainting;
            
            AddInitialRows(5);
        }

        private void SetupColumnIcons()
        {
            SetColumnHeaderWithIcon(colPeakVolts, "Peak Volts", ColumnIconHelper.CreatePeakVoltsIcon());
            SetColumnHeaderWithIcon(colRMSVolts, "RMS Volts", ColumnIconHelper.CreateRMSVoltsIcon());
            SetColumnHeaderWithIcon(colSupplyCurrent, "Supply Current", ColumnIconHelper.CreateCurrentIcon());
            SetColumnHeaderWithIcon(colSupplyVoltage, "Supply Voltage", ColumnIconHelper.CreateVoltageIcon());
            SetColumnHeaderWithIcon(colPowerIn, "Power In", ColumnIconHelper.CreatePowerInIcon());
            SetColumnHeaderWithIcon(colPowerOut, "Power Out", ColumnIconHelper.CreatePowerOutIcon());
            SetColumnHeaderWithIcon(colEfficiency, "Efficiency", ColumnIconHelper.CreateEfficiencyIcon());
            SetColumnHeaderWithIcon(colLoadResistance, "Load Resistance", ColumnIconHelper.CreateResistanceIcon());
            SetColumnHeaderWithIcon(colDateTime, "Date/Time", ColumnIconHelper.CreateDateTimeIcon());
        }

        private void SetColumnHeaderWithIcon(DataGridViewColumn column, string text, Bitmap icon)
        {
            column.HeaderText = " " + text;
            
            if (dataGridView1.ColumnHeadersDefaultCellStyle.Padding == Padding.Empty)
            {
                dataGridView1.ColumnHeadersDefaultCellStyle.Padding = new Padding(20, 0, 0, 0);
            }
            
            dataGridView1.Paint += (sender, e) =>
            {
                foreach (DataGridViewColumn col in dataGridView1.Columns)
                {
                    Rectangle rect = dataGridView1.GetCellDisplayRectangle(col.Index, -1, true);
                    if (rect.Width > 0)
                    {
                        Bitmap colIcon = null;
                        if (col == colPeakVolts) colIcon = ColumnIconHelper.CreatePeakVoltsIcon();
                        else if (col == colRMSVolts) colIcon = ColumnIconHelper.CreateRMSVoltsIcon();
                        else if (col == colSupplyCurrent) colIcon = ColumnIconHelper.CreateCurrentIcon();
                        else if (col == colSupplyVoltage) colIcon = ColumnIconHelper.CreateVoltageIcon();
                        else if (col == colPowerIn) colIcon = ColumnIconHelper.CreatePowerInIcon();
                        else if (col == colPowerOut) colIcon = ColumnIconHelper.CreatePowerOutIcon();
                        else if (col == colEfficiency) colIcon = ColumnIconHelper.CreateEfficiencyIcon();
                        else if (col == colLoadResistance) colIcon = ColumnIconHelper.CreateResistanceIcon();
                        else if (col == colDateTime) colIcon = ColumnIconHelper.CreateDateTimeIcon();

                        if (colIcon != null)
                        {
                            e.Graphics.DrawImage(colIcon, rect.Left + 2, rect.Top + (rect.Height - 16) / 2, 16, 16);
                            colIcon.Dispose();
                        }
                    }
                }
            };
        }

        private void AddInitialRows(int count)
        {
            for (int i = 0; i < count; i++)
            {
                int rowIndex = dataGridView1.Rows.Add();
                dataGridView1.Rows[rowIndex].Cells["colSupplyVoltage"].Value = _defaultSupplyVoltage;
                dataGridView1.Rows[rowIndex].Cells["colSupplyVoltage"].Tag = "default";
                dataGridView1.Rows[rowIndex].Cells["colLoadResistance"].Value = _defaultLoadResistance;
                dataGridView1.Rows[rowIndex].Cells["colLoadResistance"].Tag = "default";
                dataGridView1.Rows[rowIndex].Cells["colDateTime"].Value = DateTime.Now.ToString("g");
            }
        }

        private void DataGridView1_DefaultValuesNeeded(object sender, DataGridViewRowEventArgs e)
        {
            e.Row.Cells["colSupplyVoltage"].Value = _defaultSupplyVoltage;
            e.Row.Cells["colSupplyVoltage"].Tag = "default";
            e.Row.Cells["colLoadResistance"].Value = _defaultLoadResistance;
            e.Row.Cells["colLoadResistance"].Tag = "default";
            e.Row.Cells["colDateTime"].Value = DateTime.Now.ToString("g");
        }

        private void DataGridView1_CellValueChanged(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex < 0 || _isPropagatingValues) return;
            
            if (!_isLoadingColumns && !_isCalculating)
            {
                _isDirty = true;
                UpdateTitle();
            }
            
            if (_isCalculating || _isLoadingColumns) return;

            string colName = dataGridView1.Columns[e.ColumnIndex].Name;
            
            if (colName == "colSupplyVoltage")
            {
                dataGridView1.Rows[e.RowIndex].Cells["colSupplyVoltage"].Tag = "user-edited";
                HandleSupplyVoltageChanged(e.RowIndex);
            }
            else if (colName == "colLoadResistance")
            {
                dataGridView1.Rows[e.RowIndex].Cells["colLoadResistance"].Tag = "user-edited";
                HandleLoadResistanceChanged(e.RowIndex);
            }
            
            if (colName != "colDateTime" && colName != "colRMSVolts" && 
                colName != "colPowerIn" && colName != "colEfficiency")
            {
                dataGridView1.Rows[e.RowIndex].Cells["colDateTime"].Value = DateTime.Now.ToString("g");
            }
            
            if (colName == "colPeakVolts" || colName == "colSupplyCurrent" || 
                colName == "colSupplyVoltage" || colName == "colLoadResistance" || colName == "colPowerOut")
            {
                CalculateRow(e.RowIndex);
            }
        }

        private void HandleSupplyVoltageChanged(int changedRowIndex)
        {
            var changedCell = dataGridView1.Rows[changedRowIndex].Cells["colSupplyVoltage"];
            
            if (changedCell.Value != null && double.TryParse(changedCell.Value.ToString(), out double newVoltage))
            {
                _defaultSupplyVoltage = newVoltage;
                Properties.Settings.Default.DefaultSupplyVoltage = newVoltage;
                Properties.Settings.Default.Save();
                
                _isPropagatingValues = true;
                try
                {
                    foreach (DataGridViewRow row in dataGridView1.Rows)
                    {
                        if (row.IsNewRow || row.Index == changedRowIndex) continue;
                        
                        var voltageCell = row.Cells["colSupplyVoltage"];
                        
                        if (voltageCell.Tag == null || voltageCell.Tag.ToString() == "default")
                        {
                            voltageCell.Value = newVoltage;
                            voltageCell.Tag = "default";
                        }
                    }
                }
                finally
                {
                    _isPropagatingValues = false;
                }
            }
        }

        private void HandleLoadResistanceChanged(int changedRowIndex)
        {
            var changedCell = dataGridView1.Rows[changedRowIndex].Cells["colLoadResistance"];
            
            if (changedCell.Value != null && double.TryParse(changedCell.Value.ToString(), out double newResistance))
            {
                _defaultLoadResistance = newResistance;
                Properties.Settings.Default.DefaultLoadResistance = newResistance;
                Properties.Settings.Default.Save();
                
                _isPropagatingValues = true;
                try
                {
                    foreach (DataGridViewRow row in dataGridView1.Rows)
                    {
                        if (row.IsNewRow || row.Index == changedRowIndex) continue;
                        
                        var resistanceCell = row.Cells["colLoadResistance"];
                        
                        if (resistanceCell.Tag == null || resistanceCell.Tag.ToString() == "default")
                        {
                            resistanceCell.Value = newResistance;
                            resistanceCell.Tag = "default";
                        }
                    }
                }
                finally
                {
                    _isPropagatingValues = false;
                }
            }
        }

        private void DataGridView1_CellPainting(object sender, DataGridViewCellPaintingEventArgs e)
        {
            if (e.ColumnIndex == colEfficiency.Index && e.RowIndex >= 0)
            {
                if (double.TryParse(Convert.ToString(e.Value), out double efficiency) && efficiency > 0)
                {
                    e.Paint(e.CellBounds, DataGridViewPaintParts.Background | DataGridViewPaintParts.Border);

                    int padding = 3;
                    int barHeight = 4;
                    int barWidth = e.CellBounds.Width - (padding * 2);
                    int barX = e.CellBounds.X + padding;
                    int barY = e.CellBounds.Y + e.CellBounds.Height - barHeight - padding;

                    Color barColor;
                    if (efficiency <= 20)
                        barColor = Color.FromArgb(220, 50, 50);
                    else if (efficiency <= 40)
                        barColor = Color.FromArgb(255, 140, 0);
                    else
                        barColor = Color.FromArgb(50, 180, 50);

                    using (SolidBrush bgBrush = new SolidBrush(Color.FromArgb(230, 230, 230)))
                    {
                        e.Graphics.FillRectangle(bgBrush, barX, barY, barWidth, barHeight);
                    }

                    double cappedEfficiency = Math.Min(efficiency, 100);
                    int filledWidth = (int)(barWidth * (cappedEfficiency / 100.0));

                    using (SolidBrush fillBrush = new SolidBrush(barColor))
                    {
                        if (filledWidth > 0)
                        {
                            e.Graphics.FillRectangle(fillBrush, barX, barY, filledWidth, barHeight);
                        }
                    }

                    if (e.Value != null)
                    {
                        TextFormatFlags flags = TextFormatFlags.HorizontalCenter | TextFormatFlags.VerticalCenter;
                        Rectangle textRect = new Rectangle(e.CellBounds.X, e.CellBounds.Y, 
                            e.CellBounds.Width, e.CellBounds.Height - barHeight - padding);
                        TextRenderer.DrawText(e.Graphics, e.Value.ToString(), e.CellStyle.Font, 
                            textRect, e.CellStyle.ForeColor, flags);
                    }

                    e.Handled = true;
                }
            }
        }

        private void DataGridView1_RowsAdded(object sender, DataGridViewRowsAddedEventArgs e)
        {
            if (!_isLoadingColumns) 
            {
                _isDirty = true;
                UpdateTitle();
            }
        }

        private void DataGridView1_RowsRemoved(object sender, DataGridViewRowsRemovedEventArgs e)
        {
            if (!_isLoadingColumns) 
            {
                _isDirty = true;
                UpdateTitle();
            }
        }

        private void DataGridView1_ColumnWidthChanged(object sender, DataGridViewColumnEventArgs e)
        {
            if (dataGridView1.AutoSizeColumnsMode == DataGridViewAutoSizeColumnsMode.None && !_isLoadingColumns)
            {
                SaveColumnWidths();
            }
        }

        private void DataGridView1_ColumnDisplayIndexChanged(object sender, DataGridViewColumnEventArgs e)
        {
            if (!_isLoadingColumns)
            {
                SaveColumnOrder();
            }
        }
    }
}
